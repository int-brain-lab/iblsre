<IfModule mod_ssl.c>
    <VirtualHost *:80>
        ServerName ${APACHE_SERVER_NAME}
        Redirect permanent / https://${APACHE_SERVER_NAME}/
    </VirtualHost>

    <VirtualHost *:443>
        ServerName ${APACHE_SERVER_NAME}

        Include sites-available/alyx-common.conf

        # Configurations for easy maintenance mode
        RewriteEngine On
        RewriteCond %{ENV:REDIRECT_STATUS} !=503
        RewriteCond "/var/www/alyx/maintenance.trigger" -f
        RewriteRule ^(.*)$ /$1 [R=503,L]

        # Apache metrics endpoint
        <Location "/server-status">
            SetHandler server-status
            Require local
            Require ip 172.16.0.0/12
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
        </Location>

        <Location "/server-info">
            SetHandler server-info
            Require local
            Require ip 172.16.0.0/12
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
        </Location>

# autoconfig
SSLCertificateFile /etc/letsencrypt/live/${APACHE_SERVER_NAME}/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/${APACHE_SERVER_NAME}/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf

    </VirtualHost>
</IfModule>
<IfModule !mod_ssl.c>
    <VirtualHost *:80>
        ServerName localhost
        Include sites-available/alyx-common.conf

        # Apache metrics endpoint for non-SSL
        <Location "/server-status">
            SetHandler server-status
            Require local
            Require ip 172.16.0.0/12
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
        </Location>

        <Location "/server-info">
            SetHandler server-info
            Require local
            Require ip 172.16.0.0/12
            Require ip 10.0.0.0/8
            Require ip 192.168.0.0/16
        </Location>
    </VirtualHost>
</IfModule>